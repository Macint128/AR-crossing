<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>동숲 그림 스튜디오</title>
  <link rel="apple-touch-icon" href="icon.png" />
  <meta name="apple-mobile-web-app-title" content="동숲 그림 스튜디오" />
  <style>
    body {
      margin: 0;
      background-color: #f0f8f0;
      font-family: 'Arial', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
    }

    #home, #editor {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }

    #home.active, #editor.active {
      display: flex;
    }

    h1 {
      color: #3b6e3b;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      margin: 10px;
      text-shadow: 1px 1px 2px #a0cfa0;
    }

    button {
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      background-color: #7cc47f;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #64a86a;
    }

    #canvasContainer {
      position: relative;
      width: 512px;
      height: 512px;
      border: 5px dashed #aad4aa;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(100, 150, 100, 0.5);
      margin-bottom: 10px;
    }

    canvas {
      position: absolute;
      left: 0;
      top: 0;
      width: 512px;
      height: 512px;
      touch-action: none;
    }

    .toolbar {
      margin: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    input[type="color"], input[type="range"] {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- 홈화면 -->
  <div id="home" class="active">
    <h1>🎨 동숲 그림 스튜디오 🍃</h1>
    <button id="startBtn">그림 시작하기</button>
  </div>

  <!-- 그림 화면 -->
  <div id="editor">
    <h1>동숲 그림판 ✏️</h1>
    <div id="canvasContainer"></div>
    <div class="toolbar">
      <input type="color" id="colorPicker" value="#3b6e3b" />
      <label>브러시 크기: <input type="range" id="brushSize" min="1" max="50" value="5" /></label>
      <input type="file" id="brushUpload" accept="image/png" />
      <button id="addLayerBtn">➕ 레이어 추가</button>
      <button id="undoBtn">↩️ 되돌리기</button>
      <button id="redoBtn">↪️ 다시 실행</button>
      <button id="clearBtn">🧹 전체 지우기</button>
      <button id="saveBtn">💾 저장하기</button>
      <button id="homeBtn">🏠 홈으로</button>
    </div>
  </div>

  <script>
    const home = document.getElementById('home');
    const editor = document.getElementById('editor');
    const startBtn = document.getElementById('startBtn');
    const homeBtn = document.getElementById('homeBtn');
    const canvasContainer = document.getElementById('canvasContainer');

    const colorPicker = document.getElementById('colorPicker');
    const brushSize = document.getElementById('brushSize');
    const brushUpload = document.getElementById('brushUpload');
    const addLayerBtn = document.getElementById('addLayerBtn');
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');
    const clearBtn = document.getElementById('clearBtn');
    const saveBtn = document.getElementById('saveBtn');

    let layers = [];
    let activeLayer = null;
    let drawing = false;
    let history = [];
    let redoStack = [];
    let customBrush = null;

    startBtn.addEventListener('click', () => {
      home.classList.remove('active');
      editor.classList.add('active');
      initCanvas();
    });

    homeBtn.addEventListener('click', () => {
      editor.classList.remove('active');
      home.classList.add('active');
    });

    function initCanvas() {
      canvasContainer.innerHTML = '';
      layers = [];
      addNewLayer();
    }

    function addNewLayer() {
      const canvas = document.createElement('canvas');
      canvas.width = 512;
      canvas.height = 512;
      canvasContainer.appendChild(canvas);
      layers.push(canvas);
      setActiveLayer(canvas);

      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      canvas.addEventListener('mousemove', draw);

      canvas.addEventListener('touchstart', startDrawingTouch);
      canvas.addEventListener('touchend', stopDrawing);
      canvas.addEventListener('touchcancel', stopDrawing);
      canvas.addEventListener('touchmove', drawTouch);

      saveState();
    }

    function setActiveLayer(canvas) {
      layers.forEach(c => c.style.zIndex = 0);
      canvas.style.zIndex = 10;
      activeLayer = canvas;
    }

    addLayerBtn.addEventListener('click', addNewLayer);

    function startDrawing(e) {
      drawing = true;
      const ctx = activeLayer.getContext('2d');
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    }

    function startDrawingTouch(e) {
      e.preventDefault();
      drawing = true;
      const ctx = activeLayer.getContext('2d');
      const rect = activeLayer.getBoundingClientRect();
      const touch = e.touches[0];
      ctx.beginPath();
      ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
    }

    function stopDrawing() {
      if (drawing) {
        drawing = false;
        saveState();
      }
    }

    function draw(e) {
      if (!drawing) return;
      const ctx = activeLayer.getContext('2d');
      ctx.lineWidth = brushSize.value;
      ctx.lineCap = 'round';

      if (customBrush) {
        ctx.drawImage(customBrush, e.offsetX - brushSize.value/2, e.offsetY - brushSize.value/2, brushSize.value, brushSize.value);
      } else {
        ctx.strokeStyle = colorPicker.value;
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
      }
    }

    function drawTouch(e) {
      e.preventDefault();
      if (!drawing) return;
      const ctx = activeLayer.getContext('2d');
      const rect = activeLayer.getBoundingClientRect();
      const touch = e.touches[0];

      if (customBrush) {
        ctx.drawImage(customBrush, touch.clientX - rect.left - brushSize.value/2, touch.clientY - rect.top - brushSize.value/2, brushSize.value, brushSize.value);
      } else {
        ctx.strokeStyle = colorPicker.value;
        ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
        ctx.stroke();
      }
    }

    brushUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const img = new Image();
        img.onload = () => {
          customBrush = img;
        };
        img.src = URL.createObjectURL(file);
      }
    });

    function saveState() {
      const state = layers.map(canvas => canvas.toDataURL());
      history.push(state);
      redoStack = [];
    }

    function undo() {
      if (history.length > 1) {
        redoStack.push(history.pop());
        const prevState = history[history.length - 1];
        prevState.forEach((imgSrc, index) => {
          const img = new Image();
          img.onload = () => {
            const ctx = layers[index].getContext('2d');
            ctx.clearRect(0, 0, 512, 512);
            ctx.drawImage(img, 0, 0);
          };
          img.src = imgSrc;
        });
      }
    }

    function redo() {
      if (redoStack.length > 0) {
        const nextState = redoStack.pop();
        history.push(nextState);
        nextState.forEach((imgSrc, index) => {
          const img = new Image();
          img.onload = () => {
            const ctx = layers[index].getContext('2d');
            ctx.clearRect(0, 0, 512, 512);
            ctx.drawImage(img, 0, 0);
          };
          img.src = imgSrc;
        });
      }
    }

    function clearCanvas() {
      layers.forEach(canvas => {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, 512, 512);
      });
      saveState();
    }

    function saveImage() {
      const finalCanvas = document.createElement('canvas');
      finalCanvas.width = 512;
      finalCanvas.height = 512;
      const ctx = finalCanvas.getContext('2d');
      layers.forEach(layer => {
        ctx.drawImage(layer, 0, 0);
      });

      const link = document.createElement('a');
      link.download = 'dongsoop_masterpiece.png';
      link.href = finalCanvas.toDataURL('image/png');
      link.click();
    }

    undoBtn.addEventListener('click', undo);
    redoBtn.addEventListener('click', redo);
    clearBtn.addEventListener('click', clearCanvas);
    saveBtn.addEventListener('click', saveImage);
  </script>
</body>
</html>
